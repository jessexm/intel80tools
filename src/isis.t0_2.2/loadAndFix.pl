%patches = (
    0x388E => "32314544373337313234324537303445",   # change uninitalised data
    0x389E => "32433436323532454545373132333730",
    0x38AE => "323132390D0A7F203A31443545463130",
    0x38BE => "30303037313445324334363235324545",
    0x38CE => "37354543444235344443333039354632",
    0x38DE => "31373037343445324334364344374234",
    0x38EE => "453045324343443238344246430D0A7F",
    0x38FE => "203A3144354630453030344643353045",
    0x390E => "30444344323834424431423332463046",
    0x391E => "44323231354630453031434433303432",
    0x392E => "32413730373432333232373037344333",
    0x393E => "4244354539300D0A7F203A3144354632",
    0x394E => "4230304339323138343734373132",
    0x39E3 => "32463446373832463244373132333737",   # set uninitalised data
    0x39F3 => "32453831374530464432374535463243",
    0x3A03 => "34453243343643443046344543333939",
    0x3A13 => "3546324334453243343631410D0A7F20",
    0x3A23 => "3A314435463832303032353245453437",
    0x3A33 => "31323337303234324537453445324334",
    0x3A43 => "36323145373730354543443934344432",
    0x3A53 => "31444637303737323138383734344532",
    0x3A63 => "43343645460D0A7F203A314435463946",
    0x3A73 => "30303231453737303545434442333433",
    0x3A83 => "32343245383837373233373032314446",
    0x3A93 => "37303936344637384445303042314341",
    0x3AA3 => "44333546323138363734344541370D0A",
    0x3AB3 => "7F203A31443546424330303243343632",
    0x3AC3 => "35324542323731323337303231444637",
    0x3AD3 => "30344530363030323138383734354532",
    0x3AE3 => "43353643443645343732413836373432",
    0x3AF3 => "333232383631420D0A7F203A31443546",
    0x3B03 => "44393030373432413832373432333232",
    0x3B13 => "38323734454237424436303035463741",
    0x3B23 => "44453030423343384333333635464339",
    0x3B33 => "30313841373443443833353143444530",
    0x3B43 => "0D0A7F203A3144354646363030353934",
    0x3B53 => "36434442443544324630464432303536",
    0x3B63 => "30304530394344333034323231444437",
    0x3B73 => "30374544363030443630313946");


# load hex file
open($in, "<isist0.hex") or die "can't open isist0.hex\n";

my $laddr = 0xffff;
my $haddr = 0;

while (<$in>) {
    next unless /^ :/;
    chomp;
    my $binrec = pack("H*", substr( $_, 2));
    die unless unpack( "%8C*", $binrec ) == 0;
    my( $addr, $type, $data ) = unpack( "x n C X4 C x3 /a", $binrec);
    if ($type == 0 && $addr != 0) {
        $laddr = $addr if $addr < $laddr;
        for my $b (unpack("C*", $data)) {
            $code[$addr++] = $b;
        }
        $haddr = $addr if $addr > $haddr;
    }
}
close $in;

# patch file
for my $addr (keys %patches) {
    $laddr = $addr if $addr < $laddr;
    for $b (unpack("C*", pack("H*", $patches{$addr}))) {
        $code[$addr++] = $b;
    }
    $haddr = $addr if $addr > $haddr;
}

# write the binary file
open $out, ">:raw", "isis.t0" or die "can't create isis.t0\n";
print $out pack("C*", @code[$laddr..$haddr - 1]);
close $out;
